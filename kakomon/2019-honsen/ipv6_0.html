<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>IPv6問題 - study-note</title>
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "light" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../../index.html"><strong aria-hidden="true">1.</strong> これは何？</a></li><li class="chapter-item expanded "><a href="../../result.html"><strong aria-hidden="true">2.</strong> 結果</a></li><li class="chapter-item expanded "><a href="../../learn-schedule.html"><strong aria-hidden="true">3.</strong> 勉強会のスケジュール</a></li><li class="chapter-item expanded "><a href="../../kakomon/summary.html"><strong aria-hidden="true">4.</strong> 過去問勉強会</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../kakomon/2019-honsen/summary.html"><strong aria-hidden="true">4.1.</strong> 2019-本選-</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../kakomon/2019-honsen/container.html"><strong aria-hidden="true">4.1.1.</strong> コンテナ問題</a></li><li class="chapter-item expanded "><a href="../../kakomon/2019-honsen/ipv6_0.html" class="active"><strong aria-hidden="true">4.1.2.</strong> IPv6問題</a></li><li class="chapter-item expanded "><a href="../../kakomon/2019-honsen/web0.html"><strong aria-hidden="true">4.1.3.</strong> Web問題</a></li></ol></li><li class="chapter-item expanded "><a href="../../kakomon/2019-yosen1/summary.html"><strong aria-hidden="true">4.2.</strong> 2019-1次予選-</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../kakomon/2019-yosen1/routing0.html"><strong aria-hidden="true">4.2.1.</strong> ルーティング問題</a></li><li class="chapter-item expanded "><a href="../../kakomon/2019-yosen1/web0.html"><strong aria-hidden="true">4.2.2.</strong> Web問題</a></li></ol></li><li class="chapter-item expanded "><a href="../../kakomon/2019-yosen2/summary.html"><strong aria-hidden="true">4.3.</strong> 2019-2次予選-</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../kakomon/2019-yosen2/container.html"><strong aria-hidden="true">4.3.1.</strong> コンテナ問題</a></li><li class="chapter-item expanded "><a href="../../kakomon/2019-yosen2/db0.html"><strong aria-hidden="true">4.3.2.</strong> DB問題</a></li><li class="chapter-item expanded "><a href="../../kakomon/2019-yosen2/ipv6_0.html"><strong aria-hidden="true">4.3.3.</strong> IPv6問題</a></li><li class="chapter-item expanded "><a href="../../kakomon/2019-yosen2/web0.html"><strong aria-hidden="true">4.3.4.</strong> Web問題</a></li></ol></li><li class="chapter-item expanded "><a href="../../kakomon/2020-honsen/summary.html"><strong aria-hidden="true">4.4.</strong> 2020-本選-</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../kakomon/2020-honsen/container3.html"><strong aria-hidden="true">4.4.1.</strong> コンテナ問題</a></li><li class="chapter-item expanded "><a href="../../kakomon/2020-honsen/dns0.html"><strong aria-hidden="true">4.4.2.</strong> DNS問題(1)</a></li><li class="chapter-item expanded "><a href="../../kakomon/2020-honsen/dns2.html"><strong aria-hidden="true">4.4.3.</strong> DNS問題(2)</a></li><li class="chapter-item expanded "><a href="../../kakomon/2020-honsen/k8s1.html"><strong aria-hidden="true">4.4.4.</strong> k8s問題</a></li><li class="chapter-item expanded "><a href="../../kakomon/2020-honsen/program0.html"><strong aria-hidden="true">4.4.5.</strong> プログラム問題(1)</a></li><li class="chapter-item expanded "><a href="../../kakomon/2020-honsen/program1.html"><strong aria-hidden="true">4.4.6.</strong> プログラム問題(2)</a></li><li class="chapter-item expanded "><a href="../../kakomon/2020-honsen/routing0.html"><strong aria-hidden="true">4.4.7.</strong> ルーティング問題</a></li><li class="chapter-item expanded "><a href="../../kakomon/2020-honsen/tunnel0.html"><strong aria-hidden="true">4.4.8.</strong> トンネル問題</a></li><li class="chapter-item expanded "><a href="../../kakomon/2020-honsen/web0.html"><strong aria-hidden="true">4.4.9.</strong> Web問題</a></li></ol></li><li class="chapter-item expanded "><a href="../../kakomon/2020-yosen/summary.html"><strong aria-hidden="true">4.5.</strong> 2020-予選-</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../kakomon/2020-yosen/container1.html"><strong aria-hidden="true">4.5.1.</strong> コンテナ問題(1)</a></li><li class="chapter-item expanded "><a href="../../kakomon/2020-yosen/container2.html"><strong aria-hidden="true">4.5.2.</strong> コンテナ問題(2)</a></li><li class="chapter-item expanded "><a href="../../kakomon/2020-yosen/db0.html"><strong aria-hidden="true">4.5.3.</strong> DB問題</a></li><li class="chapter-item expanded "><a href="../../kakomon/2020-yosen/programming0.html"><strong aria-hidden="true">4.5.4.</strong> プログラム問題</a></li><li class="chapter-item expanded "><a href="../../kakomon/2020-yosen/routing0.html"><strong aria-hidden="true">4.5.5.</strong> ルーティング問題(1)</a></li><li class="chapter-item expanded "><a href="../../kakomon/2020-yosen/routing1.html"><strong aria-hidden="true">4.5.6.</strong> ルーティング問題(2)</a></li><li class="chapter-item expanded "><a href="../../kakomon/2020-yosen/routing3.html"><strong aria-hidden="true">4.5.7.</strong> ルーティング問題(3)</a></li><li class="chapter-item expanded "><a href="../../kakomon/2020-yosen/web01.html"><strong aria-hidden="true">4.5.8.</strong> Web問題</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../../docker/summary.html"><strong aria-hidden="true">5.</strong> docker</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../docker/learn.html"><strong aria-hidden="true">5.1.</strong> learn</a></li><li class="chapter-item expanded "><a href="../../docker/hands-on.html"><strong aria-hidden="true">5.2.</strong> hands-on</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                    </div>

                    <h1 class="menu-title">study-note</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                    </div>
                </div>

                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#v4v6-移行が終わらない" id="v4v6-移行が終わらない">v4v6 移行が終わらない</a></h1>
<p>解いた人:<a href="https://github.com/momom-i">momom-i</a></p>
<p>参照した問題・解説のサイト:<a href="https://blog.icttoracon.net/2020/03/01/v4v6%E7%A7%BB%E8%A1%8C%E3%81%8C%E7%B5%82%E3%82%8F%E3%82%89%E3%81%AA%E3%81%84/">v4v6 移行が終わらない</a></p>
<h1><a class="header" href="#問題" id="問題">問題</a></h1>
<p>おお久しぶり！！</p>
<p>君が居ないあいだに社内ネットワークを IPv6 only にしておいたんだ。外向きの IP アドレスは v4 しかないけどルーターで NAT64 をしているからインターネットにはつながるようになっているよ。</p>
<p>ただ名前解決ができないのと社内ネットワークにある Web に繋がらなくなっちゃったんだ、これ以上は手が付かないから君がなんとかしてくれないかな？</p>
<h3><a class="header" href="#初期状態" id="初期状態">初期状態</a></h3>
<ul>
<li><code>ubuntu-1</code> から <code>curl https://blog.icttoracon.net/</code> をしてもつながらない</li>
<li><code>ubuntu-1</code> から <code>curl http://[2403:bd80:c000:900::1]/</code> をしてもつながらない</li>
</ul>
<h3><a class="header" href="#終了状態" id="終了状態">終了状態</a></h3>
<ul>
<li><code>ubuntu-1</code> から <code>curl https://blog.icttoracon.net/</code> をするとステータスコード 200 のレスポンスが返ってくる。</li>
<li><code>ubuntu-1</code> から <code>curl http://[2403:bd80:c000:900::1]/</code> をするとステータスコード 200 のレスポンスが返ってくる。</li>
</ul>
<h3><a class="header" href="#配点" id="配点">配点</a></h3>
<ul>
<li><code>ubuntu-1</code> から <code>curl https://blog.icttoracon.net/</code> をするとステータスコード 200 のレスポンスが返ってくる
80%</li>
<li><code>ubuntu-1</code> から <code>curl http://[2403:bd80:c000:900::1]/</code> をするとステータスコード 200 のレスポンスが返ってくる。
20%</li>
</ul>
<h3><a class="header" href="#問題文でされた操作" id="問題文でされた操作">問題文でされた操作</a></h3>
<ol>
<li>社内ネットワークを IPv6 only にした</li>
<li>外向き IP アドレスは v4 しかないが、ルーターで NAT64 をしている</li>
</ol>
<hr />
<h2><a class="header" href="#httpsblogicttoraconnetが返らない原因" id="httpsblogicttoraconnetが返らない原因"><code>https://blog.icttoracon.net/</code>が返らない原因</a></h2>
<h4><a class="header" href="#プリフィックスのある-v6-アドレスを-dns-で生成されていない" id="プリフィックスのある-v6-アドレスを-dns-で生成されていない">プリフィックスのある v6 アドレスを DNS で生成されていない</a></h4>
<p>まずは、DNS で IPv6 アドレスを問い合わせてみる</p>
<pre><code class="language-shell=">dig -t AAAA blog.icttoracon.net +short
</code></pre>
<blockquote>
<p>NAT64、DNS64 そして通信に介在するネットワーク機器は同じ IPv4-IPv6 変換アドレス用のプリフィクスを使用するよう設定されている必要があります。(<a href="https://www.nic.ad.jp/ja/newsletter/No64/0800.html">参照</a>)</p>
</blockquote>
<p>今回は外向き IP アドレスは v4 のみなのでプリフィックスのある v6 アドレスが返されないといけない。</p>
<h2><a class="header" href="#https2403bd80c0009001が返らない原因" id="https2403bd80c0009001が返らない原因"><code>https://[2403:bd80:c000:900::1]/</code>が返らない原因</a></h2>
<p><code>ping6 2403:bd80:c000:900::1</code>をしてみる。もし疎通性がなければ、パケットフィルタリングが問題。もし疎通性があれば、前回と同様で web サーバが IPv6 で受け付けてないとか nginx だったら config の不備が問題。</p>
<h2><a class="header" href="#考えられる解決方法" id="考えられる解決方法">考えられる解決方法</a></h2>
<h4><a class="header" href="#dns64-に対応させる" id="dns64-に対応させる">DNS64 に対応させる</a></h4>
<p>BIND の場合、BIND のバージョンが 9.8 以降か確認し、/etc/bind/named.conf に以下のような記述 DNS64 の設定があるか確認する</p>
<pre><code class="language-yaml=">options {
    # IPv4は32bitなので96bit付け足してIPv6に対応させる
    dns64 64:ff9b::/96 {
    #     クライアントを指定できるが、anyで良い気がする
        clients { any; };
    };
};
</code></pre>
<p><code>service named restart</code>をして再起動</p>
<p>UNBOUND の場合は、/etc/unbound/unbound.conf に</p>
<pre><code class="language-yaml=">server:
    # dns64をつければ後の文字はなんでも良いっぽい
    module-config: &quot;dns64 validator iterator&quot;
    dns64-prefix: 64:ff9b::/96
</code></pre>
<p>を設定して、<code>unbound -c unbound.conf</code>で設定を読み込み</p>
<p>※参照サイト: <br>1.<a href="https://www.oreilly.com/library/view/dns-and-bind/9781449308025/ch04.html">オライリー DNS64 ページ</a><br>2.<a href="https://github.com/NLnetLabs/unbound/blob/master/doc/README.DNS64">unbound 公式 DNS64 ドキュメント</a></p>
<h4><a class="header" href="#nginx-の-config-を修正" id="nginx-の-config-を修正">Nginx の config を修正</a></h4>
<p>/etc/nginx/nginx.conf の<code>listen 80;</code>の下に以下のような記述があるか確認。</p>
<pre><code class="language-yaml="># IPv6のポート80でリッスンするよ〜という記述
listen [::]:80;
</code></pre>
<h4><a class="header" href="#パケットフィルタリング" id="パケットフィルタリング">パケットフィルタリング</a></h4>
<p>ip6tables という IPv6 の iptables コマンドで確認ができるらしい！(<a href="https://linux.die.net/man/8/ip6tables">参照</a>)</p>
<pre><code class="language-shell=">ip6tables -L
</code></pre>
<p>アプリケーションに必要なポートを web サーバ側で許可する</p>
<pre><code class="language-shell="># TCP80番ポートのアクセス許可
ip6tables -A INPUT -p tcp --dport 80 -j ACCEPT
</code></pre>
<h3><a class="header" href="#参考" id="参考">※参考※</a></h3>
<ul>
<li>NAT64:IPv6 ホストが IPv4 サーバーと通信することができるようにする技術(<a href="https://www.nic.ad.jp/ja/newsletter/No64/0800.html">わかりやすい仕組み解説</a>)</li>
</ul>
<hr />
<h2><a class="header" href="#解説" id="解説">解説</a></h2>
<p>unbound と Apache2 の設定が適切になされていないことで起こる問題です。</p>
<h3><a class="header" href="#unbound" id="unbound">unbound</a></h3>
<p><code>dns64-prefix</code> は <code>ubuntu-router</code> の <code>JOOL</code> の設定を参照する必要があります。これを確認すると <code>dns64-prefix</code> が <code>64:ff9b::/96</code> で有ることがわかります。(<code>jool global display</code>コマンドの<code>pool6</code>で prefix が確認できそう(<a href="https://www.jool.mx/en/usr-flags-global.html">参照</a>))</p>
<p>また、<code>blog.icttoracon.net</code> ではデュアルスタック方式を採用しているおり <code>dns64-synthall</code> が no に設定されていると、<code>blog.icttoracon.net</code> にもともと設定されている IPv6 アドレスが AAAA レコードとして名前解決されるため、 <code>ubuntu-1</code> からアクセスすることができなくなってしまいます。(元から AAAA レコードに何かアドレスが入っていたっぽいな。dns64-synthall のオンオフによる挙動は<a href="https://blog.nic.ad.jp/2016/794/">ここら辺</a>に載っている)</p>
<p>さらに、この <code>dns-1</code> のサーバーは <code>NAT64</code> ネットワーク内に設置されているために forward-addr が <code>8.8.8.8 </code>になっていると通信が行えません。<code>forward-addr: 64:ff9b::808:808</code> に変更する必要があります。(そうだったのか^^;;)</p>
<p>問題が発生している原因は 2 つ存在している。1 つ目は、unbound に DNS64 の設定が正しくされていない点である。これを解決するために <code>/etc/unbound/unbound.conf.d/dns.conf</code> を以下のように変更する。(<a href="https://github.com/fastly/unbound/blob/master/doc/example.conf.in">公式の example.conf 参照</a>)</p>
<pre><code class="language-yaml=">server:
# ログレベル
  verbosity: 2
#   pidfileの場所指定
  pidfile: &quot;/var/run/unbound.pid&quot;
#   ログを出すかどうか
  use-syslog: yes
#   さっき書いた通りでdns64を使用する場合はかく
  module-config: &quot;dns64 iterator&quot;
#   prefixを指定する
  dns64-prefix: 64:ff9b::/96
#   yesにするとDNS64やNAT64を通るようになる
  dns64-synthall: yes
  interface: ::0
  access-control: ::0/0 allow

forward-zone:
# `.`にすると全て転送される
  name: &quot;.&quot;
#   8.8.8.8のプレフィックス付きIPv6アドレス。
  forward-addr: 64:ff9b::808:808
</code></pre>
<p>これにより <code>https://blog.icttoracon.net/</code> にアクセスできるようになる。</p>
<p>2 つ目の原因は <code>ubuntu-router</code> の Web (Apache2) の Listen Address が適切に設定されていないことにある。これを解決するために以下の一行を config に追記する。</p>
<pre><code class="language-yaml=">Listen [::0]:80
</code></pre>
<h3><a class="header" href="#参考-1" id="参考-1">※参考※</a></h3>
<ul>
<li>NAT64:IPv6 ホストが IPv4 サーバーと通信することができるようにする技術(<a href="https://www.nic.ad.jp/ja/newsletter/No64/0800.html">わかりやすい仕組み解説</a>)</li>
<li>JOOL:Linux 向け NAT64 オープンソース(<a href="https://www.jool.mx/en/">参照</a>)</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../../kakomon/2019-honsen/container.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../../kakomon/2019-honsen/web0.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../../kakomon/2019-honsen/container.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="../../kakomon/2019-honsen/web0.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        
        
        
        <script type="text/javascript">
            window.playpen_copyable = true;
        </script>
        

        

        

        <script src="../../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
