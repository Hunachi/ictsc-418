<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>IPv6問題 - study-note</title>
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "light" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../../index.html"><strong aria-hidden="true">1.</strong> これは何？</a></li><li class="chapter-item expanded "><a href="../../result.html"><strong aria-hidden="true">2.</strong> 結果</a></li><li class="chapter-item expanded "><a href="../../learn-schedule.html"><strong aria-hidden="true">3.</strong> 勉強会のスケジュール</a></li><li class="chapter-item expanded "><a href="../../kakomon/summary.html"><strong aria-hidden="true">4.</strong> 過去問勉強会</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../kakomon/2019-honsen/summary.html"><strong aria-hidden="true">4.1.</strong> 2019-本選-</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../kakomon/2019-honsen/container.html"><strong aria-hidden="true">4.1.1.</strong> コンテナ問題</a></li><li class="chapter-item expanded "><a href="../../kakomon/2019-honsen/ipv6_0.html"><strong aria-hidden="true">4.1.2.</strong> IPv6問題</a></li><li class="chapter-item expanded "><a href="../../kakomon/2019-honsen/web0.html"><strong aria-hidden="true">4.1.3.</strong> Web問題</a></li></ol></li><li class="chapter-item expanded "><a href="../../kakomon/2019-yosen1/summary.html"><strong aria-hidden="true">4.2.</strong> 2019-1次予選-</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../kakomon/2019-yosen1/routing0.html"><strong aria-hidden="true">4.2.1.</strong> ルーティング問題</a></li><li class="chapter-item expanded "><a href="../../kakomon/2019-yosen1/web0.html"><strong aria-hidden="true">4.2.2.</strong> Web問題</a></li></ol></li><li class="chapter-item expanded "><a href="../../kakomon/2019-yosen2/summary.html"><strong aria-hidden="true">4.3.</strong> 2019-2次予選-</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../kakomon/2019-yosen2/container.html"><strong aria-hidden="true">4.3.1.</strong> コンテナ問題</a></li><li class="chapter-item expanded "><a href="../../kakomon/2019-yosen2/db0.html"><strong aria-hidden="true">4.3.2.</strong> DB問題</a></li><li class="chapter-item expanded "><a href="../../kakomon/2019-yosen2/ipv6_0.html" class="active"><strong aria-hidden="true">4.3.3.</strong> IPv6問題</a></li><li class="chapter-item expanded "><a href="../../kakomon/2019-yosen2/web0.html"><strong aria-hidden="true">4.3.4.</strong> Web問題</a></li></ol></li><li class="chapter-item expanded "><a href="../../kakomon/2020-honsen/summary.html"><strong aria-hidden="true">4.4.</strong> 2020-本選-</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../kakomon/2020-honsen/container3.html"><strong aria-hidden="true">4.4.1.</strong> コンテナ問題</a></li><li class="chapter-item expanded "><a href="../../kakomon/2020-honsen/dns0.html"><strong aria-hidden="true">4.4.2.</strong> DNS問題(1)</a></li><li class="chapter-item expanded "><a href="../../kakomon/2020-honsen/dns2.html"><strong aria-hidden="true">4.4.3.</strong> DNS問題(2)</a></li><li class="chapter-item expanded "><a href="../../kakomon/2020-honsen/k8s1.html"><strong aria-hidden="true">4.4.4.</strong> k8s問題</a></li><li class="chapter-item expanded "><a href="../../kakomon/2020-honsen/program0.html"><strong aria-hidden="true">4.4.5.</strong> プログラム問題(1)</a></li><li class="chapter-item expanded "><a href="../../kakomon/2020-honsen/program1.html"><strong aria-hidden="true">4.4.6.</strong> プログラム問題(2)</a></li><li class="chapter-item expanded "><a href="../../kakomon/2020-honsen/routing0.html"><strong aria-hidden="true">4.4.7.</strong> ルーティング問題</a></li><li class="chapter-item expanded "><a href="../../kakomon/2020-honsen/tunnel0.html"><strong aria-hidden="true">4.4.8.</strong> トンネル問題</a></li><li class="chapter-item expanded "><a href="../../kakomon/2020-honsen/web0.html"><strong aria-hidden="true">4.4.9.</strong> Web問題</a></li></ol></li><li class="chapter-item expanded "><a href="../../kakomon/2020-yosen/summary.html"><strong aria-hidden="true">4.5.</strong> 2020-予選-</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../kakomon/2020-yosen/container1.html"><strong aria-hidden="true">4.5.1.</strong> コンテナ問題(1)</a></li><li class="chapter-item expanded "><a href="../../kakomon/2020-yosen/container2.html"><strong aria-hidden="true">4.5.2.</strong> コンテナ問題(2)</a></li><li class="chapter-item expanded "><a href="../../kakomon/2020-yosen/db0.html"><strong aria-hidden="true">4.5.3.</strong> DB問題</a></li><li class="chapter-item expanded "><a href="../../kakomon/2020-yosen/programming0.html"><strong aria-hidden="true">4.5.4.</strong> プログラム問題</a></li><li class="chapter-item expanded "><a href="../../kakomon/2020-yosen/routing0.html"><strong aria-hidden="true">4.5.5.</strong> ルーティング問題(1)</a></li><li class="chapter-item expanded "><a href="../../kakomon/2020-yosen/routing1.html"><strong aria-hidden="true">4.5.6.</strong> ルーティング問題(2)</a></li><li class="chapter-item expanded "><a href="../../kakomon/2020-yosen/routing3.html"><strong aria-hidden="true">4.5.7.</strong> ルーティング問題(3)</a></li><li class="chapter-item expanded "><a href="../../kakomon/2020-yosen/web01.html"><strong aria-hidden="true">4.5.8.</strong> Web問題</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../../docker/summary.html"><strong aria-hidden="true">5.</strong> docker</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../docker/learn.html"><strong aria-hidden="true">5.1.</strong> learn</a></li><li class="chapter-item expanded "><a href="../../docker/hands-on.html"><strong aria-hidden="true">5.2.</strong> hands-on</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                    </div>

                    <h1 class="menu-title">study-note</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                    </div>
                </div>

                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#welcome-to-nginx-のページを表示したい" id="welcome-to-nginx-のページを表示したい">Welcome to Nginx のページを表示したい！</a></h1>
<p>解いた人:<a href="https://github.com/momom-i">momom-i</a></p>
<p>参照した問題・解説のサイト:<a href="https://blog.icttoracon.net/2019/12/10/ictsc2019-%e4%ba%8c%e6%ac%a1%e4%ba%88%e9%81%b8-%e5%95%8f%e9%a1%8c%e8%a7%a3%e8%aa%ac-welcome-to-nginx%e3%81%ae%e3%83%9a%e3%83%bc%e3%82%b8%e3%82%92%e8%a1%a8%e7%a4%ba%e3%81%97%e3%81%9f%e3%81%84%ef%bc%81/">Welcome to Nginx のページを表示したい！</a></p>
<h1><a class="header" href="#問題" id="問題">問題</a></h1>
<p>あなたはローカルネットワーク上に web サーバを構築し、IPv6 アドレスを使用して web ページに接続できるようにセットアップをしています。
web ページへは<code>http://nginx.icttoracon.net</code>でアクセスできるようにしたいです。</p>
<p>nginx のホストには、すでに nginx のパッケージをインストール済みです。
CSR1000V と nginx のホストには固定で IPv6 アドレスを割り当てました。
クライアント(VNC Server)に IPv6 アドレスが自動設定されるように、CSR1000V には SLAAC の設定を行いました。</p>
<p>しかし、クライアント(VNC Server)のブラウザから<code>http://nginx.icttoracon.net</code>にアクセスしても Welcome to Nginx のページを表示させることができません。
このトラブルを解決し、Welcome to Nginx のページを表示させてください。</p>
<p>クライアントが増えても自動でアクセスできるよう、設定変更は CSR1000V と nginx ホストのみとしてください。
DNS サーバは CSR1000V を使用します。
各ノードには ssh/telnet 用に IPv4 アドレスが設定されていますので必要に応じて使用してください。
予選終了後に実環境で採点されるので、スコアサーバでの解答は不要です。</p>
<h3><a class="header" href="#接続環境" id="接続環境">接続環境</a></h3>
<table><thead><tr><th align="left">Host</th><th align="center">Protocol</th><th align="center">IPv4 address</th><th align="center">User/Pass</th></tr></thead><tbody>
<tr><td align="left">CSR1000V</td><td align="center">telnet</td><td align="center">192.168.0.1</td><td align="center">admin/admin</td></tr>
<tr><td align="left">nginx</td><td align="center">ssh</td><td align="center">192.168.1.2</td><td align="center">admin/admin</td></tr>
</tbody></table>
<h3><a class="header" href="#問題文でされた操作" id="問題文でされた操作">問題文でされた操作</a></h3>
<ol>
<li>CSR1000V と nginx のホストに固定で IPv6 アドレスを割り当て</li>
<li>CSR1000V には SLAAC の設定</li>
</ol>
<h3><a class="header" href="#バグの内容" id="バグの内容">バグの内容</a></h3>
<p><code>http://nginx.icttoracon.net</code>にアクセスしても Welcome to Nginx のページを表示させることができない</p>
<h3><a class="header" href="#理想の終了状態" id="理想の終了状態">理想の終了状態</a></h3>
<p>Welcome to Nginx のページを表示</p>
<h2><a class="header" href="#補足事項" id="補足事項">補足事項</a></h2>
<ul>
<li>各ノードには ssh/telnet 用に IPv4 アドレスが設定されていますので必要に応じて使用</li>
<li>設定変更は CSR1000V と nginx ホストのみ</li>
</ul>
<hr />
<h2><a class="header" href="#考えられる原因" id="考えられる原因">考えられる原因</a></h2>
<h4><a class="header" href="#まず下記コマンドでクライアントからnginxicttoraconnetが引けるかipv6-アドレスが引けるか調べる" id="まず下記コマンドでクライアントからnginxicttoraconnetが引けるかipv6-アドレスが引けるか調べる">まず下記コマンドでクライアントから<code>nginx.icttoracon.net</code>が引けるか、IPv6 アドレスが引けるか調べる</a></h4>
<pre><code class="language-shell="># AAAAレコードはホスト名に対するIPv6アドレスが登録されている(ちなみにAAAAレコードはクアッドエーレコードって読むらしい！)
# +shortオプションで簡単にIPv6アドレスが登録されてるかどうか以外の情報を省ける
dig -t AAAA nginx.icttoracon.net +short
</code></pre>
<ul>
<li>もし IPv4 でも引けないなら DNS の設定問題。(問題文的に IPv4 では引けそう？)IPv4 では引けるが IPv6 アドレスが引けなかったら、DNS のゾーンファイルに IPv6 の設定がなされてない。もしどちらも登録されていたら、nginx の問題で config の書き方不備。</li>
</ul>
<h4><a class="header" href="#クライアントから-ping-で-ipv6-のアドレスにつながるかやってみる" id="クライアントから-ping-で-ipv6-のアドレスにつながるかやってみる">クライアントから ping で IPv6 のアドレスにつながるかやってみる</a></h4>
<pre><code class="language-shell="># ping6は `ping -6`と同じ
ping6 nginx.icttoracon.net
</code></pre>
<ul>
<li>もし通らなければ、SLAAC の自動 ip 割り当てあたりやパケットフィルタリングが問題。通るなら上記の問題になってくる気がする。</li>
</ul>
<h2><a class="header" href="#考えられる解決方法" id="考えられる解決方法">考えられる解決方法</a></h2>
<h4><a class="header" href="#dns-のゾーンファイルの不備を修正" id="dns-のゾーンファイルの不備を修正">DNS のゾーンファイルの不備を修正</a></h4>
<pre><code class="language-yaml="># IPv6は省略法で書けるらしい
nginx.icttoracon.net. IN AAAA fc01::2
</code></pre>
<h4><a class="header" href="#nginx-の-config-を修正" id="nginx-の-config-を修正">Nginx の config を修正</a></h4>
<p>/etc/nginx/nginx.conf の<code>listen 80;</code>の下に以下のような記述があるか確認</p>
<pre><code class="language-yaml="># IPv6のポート80でリッスンするよ〜という記述
listen [::]:80;
</code></pre>
<h4><a class="header" href="#slaac-の自動-ip-割り当て確認" id="slaac-の自動-ip-割り当て確認">SLAAC の自動 IP 割り当て確認</a></h4>
<p>基本的に<a href="https://www.n-study.com/ipv6-detail/cisco-ipv6-address-configuration/">このページ</a>を参照した</p>
<pre><code class="language-shell=">show ipv6 address
</code></pre>
<p>で確認できる。もし割り当てがおかしい場合は、Cisco のグローバルコンフィグレーションモード(Cisco のルーターの特権モード。全体の設定に関わるようなことを行う時に入るモード)に<code>configure terminal</code>で入って、</p>
<pre><code class="language-shell=">(config)#ipv6 unicast-routing
# インターフェイス名を指定する。スロットは固定で0みたい
(config)#interface gigabitethernet 0/1
(config-if)#ipv6 enable
</code></pre>
<p>※Cisco のインターフェイスについては<a href="https://www.n-study.com/cisco-basic/cisco-interface/">こちら</a></p>
<h4><a class="header" href="#パケットフィルタリング" id="パケットフィルタリング">パケットフィルタリング</a></h4>
<p>ip6tables という IPv6 の iptables コマンドで確認ができるらしい！(<a href="https://linux.die.net/man/8/ip6tables">参照</a>)</p>
<pre><code class="language-shell=">ip6tables -L
</code></pre>
<p>もし 80 番ポートの設定がなければ、今回はクライアント側は変更しないから nginx で以下のコマンドで 80 番ポートの接続を許可する</p>
<pre><code class="language-shell="># TCP80番ポートのアクセス許可
ip6tables -A INPUT -p tcp --dport 80 -j ACCEPT
</code></pre>
<h3><a class="header" href="#参考" id="参考">※参考※</a></h3>
<ul>
<li>
<p>CSR1000V(Cisco Cloud Services Router 1000V):ソフトウェアルータ(<a href="https://www.cisco.com/c/en/us/products/collateral/routers/cloud-services-router-1000v-series/data_sheet-c78-733443.html">参照</a>)</p>
</li>
<li>
<p>SLAAC(スラーク): <br>IPv6 アドレスを自動設定する技術の一つで、アドレスを発行するサーバなどを用意しなくても当該ネットワーク内のアドレスをホスト自身が設定する方式(<a href="https://e-words.jp/w/SLAAC.html">概要説明参照 URL</a>, <a href="https://www.n-study.com/ipv6-detail/ipv6-address-configuration/">具体的な挙動のわかりやすい参照 URL</a>(このページの「SLAAC による IPv6 アドレスの設定」))</p>
</li>
<li>
<p>VNC: ネットワークを通じて別のコンピュータに接続し、そのデスクトップ画面を呼び出して操作することができるリモートデスクトップソフトの一つ(<a href="https://e-words.jp/w/VNC.html">参照</a>)</p>
</li>
<li>
<p>IPv6 の記述法について: <br>例. fc01::2 = fc01:0000:0000:0000:0000:0000:0000:0002/64(<a href="https://www.infraexpert.com/study/ipv6z2.html#:%7E:text=IPv4%E3%82%A2%E3%83%89%E3%83%AC%E3%82%B9%E3%81%AF%E3%80%8132%E3%83%93%E3%83%83%E3%83%88,%E5%88%86%E3%81%9116%E9%80%B2%E6%95%B0%E3%81%A7%E8%A1%A8%E8%A8%98%E3%80%82">参照</a>)</p>
</li>
</ul>
<hr />
<h2><a class="header" href="#解説" id="解説">解説</a></h2>
<p>本問題には 3 つの原因があります。
順を追って調べてみましょう。</p>
<h4><a class="header" href="#疎通性確認" id="疎通性確認">疎通性確認</a></h4>
<p>まずはクライアントマシンから nginx ホストまで IPv6 で疎通性があるか確認してみます。
簡単な確認ではありますが、トラブル原因のレイヤをある程度限定できます。</p>
<pre><code class="language-shell="># ping6 ドメイン名ってやってたけど、普通にIPv6アドレスでpingするべきだったな^^;
ubuntu@ICTSC-VNC:~$ ping fc01::2 -c 4
PING fc01::2(fc01::2) 56 data bytes
64 bytes from fc01::2: icmp_seq=1 ttl=63 time=0.887 ms
64 bytes from fc01::2: icmp_seq=2 ttl=63 time=0.607 ms
64 bytes from fc01::2: icmp_seq=3 ttl=63 time=0.802 ms
64 bytes from fc01::2: icmp_seq=4 ttl=63 time=0.699 ms

--- fc01::2 ping statistics ---
4 packets transmitted, 4 received, 0% packet loss, time 3040ms
rtt min/avg/max/mdev = 0.607/0.748/0.887/0.110 ms
</code></pre>
<p>コマンドの結果から本問題は初期状態で IPv6 の疎通性があることが確認できます。</p>
<h4><a class="header" href="#名前解決" id="名前解決">名前解決</a></h4>
<p>名前解決ができるかどうか試してみましょう。
ドメイン名から IPv6 アドレスを取得するには AAAA レコードを参照します。
例として AAAA レコードを取得するコマンドを以下に示します。</p>
<pre><code class="language-shell=">ubuntu@ICTSC-VNC:~$ dig nginx.icttoracon.net AAAA

; &lt;&lt;&gt;&gt; DiG 9.11.3-1ubuntu1.11-Ubuntu &lt;&lt;&gt;&gt; nginx.icttoracon.net AAAA
;; global options: +cmd
;; Got answer:
;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NXDOMAIN, id: 40684
;; flags: qr rd ra; QUERY: 1, ANSWER: 0, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 65494
;; QUESTION SECTION:
;nginx.icttoracon.net.        IN  AAAA

;; Query time: 89 msec
;; SERVER: 127.0.0.53#53(127.0.0.53)
;; WHEN: Wed Dec 04 22:46:46 JST 2019
;; MSG SIZE  rcvd: 49
ubuntu@ICTSC-VNC:~$
</code></pre>
<p>AAAA レコードは取得できていません。
問題文で DNS サーバは CSR とされていますが、クライアントはどこを参照しているのでしょうか。</p>
<pre><code class="language-shell="># grep -v: invert match
# grep -v &quot;^#&quot;: #で始まるもの以外を取り出す = コメントアウト部分以外を取り出す
ubuntu@ICTSC-VNC:~$ cat /etc/resolv.conf | grep -v &quot;^#&quot;

nameserver 127.0.0.53
options edns0
search localdomain
# この/run/systemd/resolve/resolv.confは/etc/resolv.confのシンボリックリンク先
# `nameserver fc00::1`があるはず
ubuntu@ICTSC-VNC:~$ cat /run/systemd/resolve/resolv.conf | grep -v &quot;^#&quot;

nameserver 133.242.0.3
nameserver 133.242.0.4
search localdomain
ubuntu@ICTSC-VNC:~$
</code></pre>
<p>IPv4 で DNS サーバを受け取っているようですが、CSR の IP アドレスではありません。
１つ目の原因は DNS サーバ（CSR）が参照できていないことです。</p>
<p>問題文からクライアントの設定変更ではなくルータの設定変更で対応する方針であることがわかります。
クライアントの設定と CSR の設定を確認すると、クライアントの IPv6 アドレスは RA を用いた自動設定であることがわかります。
ただし DNS サーバのアドレスが配布されていません。
RA で IPv6 アドレスが設定されている場合は、以下の 2 つの方法で DNS サーバを配布することができます。</p>
<ul>
<li>ステートレス DHCPv6</li>
<li>RA を用いた DNS 配布(RFC8106)</li>
</ul>
<p>例として RA のみで DNS の配布を行います。
IOS-XE(Cisco の OS(<a href="https://www.cisco.com/c/ja_jp/products/ios-nx-os-software/ios-xe/index.html">参考</a>))のコマンドリファレンスを参照すると、以下の設定で DNS の配布が行えそうです。</p>
<pre><code class="language-shell="># conf t: さっきのconfigure terminalの省略形
csr1000v#conf t
Enter configuration commands, one per line.  End with CNTL/Z.
# int gi 1 = interface gigabitethernet 0/1と同じ
csr1000v(config)#int gi 1
csr1000v(config-if)#ipv6 nd ra dns server fc00::1
</code></pre>
<p>(<a href="https://www.cisco.com/c/en/us/td/docs/ios-xml/ios/ipv6/command/ipv6-cr-book/ipv6-i3.html#wp3145726977">ipv6 nd ra dns server fc00::1 の説明</a>)
クライアントで確認してみます。</p>
<pre><code class="language-shell=">ubuntu@ICTSC-VNC:~$ cat /run/systemd/resolve/resolv.conf | grep -v &quot;^#&quot;

nameserver 133.242.0.3
nameserver 133.242.0.4
nameserver fc00::1
search localdomain
ubuntu@ICTSC-VNC:~$ dig nginx.icttoracon.net AAAA

; &lt;&lt;&gt;&gt; DiG 9.11.3-1ubuntu1.11-Ubuntu &lt;&lt;&gt;&gt; nginx.icttoracon.net AAAA
;; global options: +cmd
;; Got answer:
;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 35863
;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 65494
;; QUESTION SECTION:
;nginx.icttoracon.net.        IN  AAAA

;; ANSWER SECTION:
nginx.icttoracon.net.    10  IN  AAAA    fc01::2

;; Query time: 12 msec
;; SERVER: 127.0.0.53#53(127.0.0.53)
;; WHEN: Wed Dec 04 22:51:49 JST 2019
;; MSG SIZE  rcvd: 77

ubuntu@ICTSC-VNC:~$
</code></pre>
<p>DNS サーバとして fc00::1 が設定され、AAAA レコードが正しく参照できています。</p>
<h4><a class="header" href="#nginx-設定" id="nginx-設定">nginx 設定</a></h4>
<p>IPv6 の疎通性があり、名前解決も行えているので一旦クライアントの作業を終え、nginx ホストを確認してみます。
まずは 80 ポートの使用状況を確認してみます。</p>
<pre><code class="language-shell=">[admin@nginx ~]$ sudo lsof -i:80
COMMAND  PID  USER   FD   TYPE DEVICE SIZE/OFF NODE NAME
nginx   1421  root    6u  IPv4   9815      0t0  TCP *:http (LISTEN)
nginx   1422 nginx    6u  IPv4   9815      0t0  TCP *:http (LISTEN)
</code></pre>
<p>type を見ると IPv4 となっており、nginx が IPv6 アドレスで待ち受けていないことがわかります。
2 つ目の原因は nginx は IPv6 アドレスで待ち受けていないことです。
nginx が IPv6 アドレスで待ち受けるよう、設定を変更します。</p>
<pre><code class="language-shell=">server {
    listen       80;
+   listen       [::]:80;
    server_name  localhost;

--- snip ---
# reload忘れてた^^;
[admin@nginx ~]$ sudo nginx -s reload
[admin@nginx ~]$ sudo nginx -s reload
[admin@nginx ~]$ sudo lsof -i:80
COMMAND  PID  USER   FD   TYPE DEVICE SIZE/OFF NODE NAME
nginx   1421  root    6u  IPv4   9815      0t0  TCP *:http (LISTEN)
nginx   1421  root   10u  IPv6  10932      0t0  TCP *:http (LISTEN)
nginx   1540 nginx    6u  IPv4   9815      0t0  TCP *:http (LISTEN)
nginx   1540 nginx   10u  IPv6  10932      0t0  TCP *:http (LISTEN)
</code></pre>
<h4><a class="header" href="#フィルタリング設定" id="フィルタリング設定">フィルタリング設定</a></h4>
<p>nginx が IPv6 で待ち受ける状態となりました。
しかしまだクライアントからアクセスができません。
nginx ホストのディストリビューションを確認してみます。</p>
<pre><code class="language-shell=">[admin@nginx ~]$ ls /etc | grep release
centos-release
redhat-release
system-release
system-release-cpe
[admin@nginx ~]$ cat /etc/centos-release
CentOS release 6.10 (Final)
[admin@nginx ~]$
</code></pre>
<p>CentOS6.10 であるため、フィルタリングは iptables で行っていると予想されます。(ここまで考えてなかった^^;)
iptables のルールを確認してみましょう。</p>
<pre><code class="language-shell=">[admin@nginx ~]$ sudo iptables -L INPUT
Chain INPUT (policy ACCEPT)
target     prot opt source               destination
ACCEPT     all  --  anywhere             anywhere            state RELATED,ESTABLISHED
ACCEPT     icmp --  anywhere             anywhere
ACCEPT     all  --  anywhere             anywhere
ACCEPT     tcp  --  anywhere             anywhere            state NEW tcp dpt:ssh
ACCEPT     tcp  --  anywhere             anywhere            state NEW tcp dpt:http
REJECT     all  --  anywhere             anywhere            reject-with icmp-host
</code></pre>
<p>一見すると問題が無いように見えますが、クライアントは Welcome to Nginx のページにアクセスできません。
それもそのはず、iptables は IPv4 のフィルタリング設定だからです。
実は初期状態から IPv4 で 80 ポートは許可されており、クライアントは IPv4 を用いて Welcome to Nginx のページを表示させることはできてました。</p>
<p>IPv6 のフィルタリングは ip6table で行います。
ip6table のルールを確認すると、80 ポートのアクセスを許可しているルールが無いことがわかります。</p>
<pre><code class="language-shell=">[admin@nginx ~]$ sudo ip6tables -L INPUT
Chain INPUT (policy ACCEPT)
target     prot opt source               destination
ACCEPT     all      anywhere             anywhere            state RELATED,ESTABLISHED
ACCEPT     ipv6-icmp    anywhere             anywhere
ACCEPT     all      anywhere             anywhere
ACCEPT     udp      anywhere             fe80::/64           state NEW udp dpt:dhcpv6-client
ACCEPT     tcp      anywhere             anywhere            state NEW tcp dpt:ssh
REJECT     all      anywhere             anywhere            reject-with icmp6-adm-prohibited

</code></pre>
<p>3 つ目の原因は IPv6 の 80 ポートが拒否されていることです。
問題文には恒久的な設定ではなくて構わないとしか記載されていないので、80 ポートを許可する方法か、プロセスを停止する方法があります。
問題としてはどちらで行ってもいいですが、望ましいのは 80 ポートを許可する方法です。
ip6tables で 80 ポートを許可します。</p>
<pre><code class="language-shell="># -m state: パケットの状態
# -m state NEW: 新規接続を対象にするという意味
# -I INPUT 6: 6番目に挿入
[admin@nginx ~]$ sudo ip6tables -I INPUT 6 -m state --state NEW -m tcp -p tcp --dport 80 -j ACCEPT
[admin@nginx ~]$ sudo ip6tables -I INPUT 6 -m state --state NEW -m tcp -p tcp --dport 80 -j ACCEPT
[admin@nginx ~]$ sudo ip6tables -L INPUT
Chain INPUT (policy ACCEPT)
target     prot opt source               destination
ACCEPT     all      anywhere             anywhere            state RELATED,ESTABLISHED
ACCEPT     ipv6-icmp    anywhere             anywhere
ACCEPT     all      anywhere             anywhere
ACCEPT     udp      anywhere             fe80::/64           state NEW udp dpt:dhcpv6-client
ACCEPT     tcp      anywhere             anywhere            state NEW tcp dpt:ssh
ACCEPT     tcp      anywhere             anywhere            state NEW tcp dpt:http
REJECT     all      anywhere             anywhere            reject-with icmp6-adm-prohibited

</code></pre>
<p>クライアントでアクセスしてみると、Welcome to Nginx のページが表示されます。</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../../kakomon/2019-yosen2/db0.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../../kakomon/2019-yosen2/web0.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../../kakomon/2019-yosen2/db0.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="../../kakomon/2019-yosen2/web0.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        
        
        
        <script type="text/javascript">
            window.playpen_copyable = true;
        </script>
        

        

        

        <script src="../../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
