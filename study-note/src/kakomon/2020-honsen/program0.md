# ä½•ã‹ãŒãŠã‹ã—ã„ã€‚ã€‚ã€‚ã€‚

[ä½•ã‹ãŒãŠã‹ã—ã„ã€‚ã€‚ã€‚ã€‚](https://blog.icttoracon.net/2021/03/16/%e4%bd%95%e3%81%8b%e3%81%8c%e3%81%8a%e3%81%8b%e3%81%97%e3%81%84%e3%80%82%e3%80%82%e3%80%82%e3%80%82/)

## ä½¿ç”¨ç’°å¢ƒãƒ»ãƒ„ãƒ¼ãƒ«
- Goè¨€èª
#### ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
- [Cobra](https://github.com/spf13/cobra)
    - ãƒ¢ãƒ€ãƒ³ãªCLIã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ç°¡å˜ã«ä½œã‚Œã‚‹ã‚ˆã†ã«ã—ã¦ãã‚Œã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼

## ãƒã‚°ã®å†…å®¹

![image](https://blog.icttoracon.net/wp-content/uploads/2021/08/6041e1892f8d9c005ac002d2-512x443.png)

R1ã«ã¦è‡ªä½œã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½œã£ãŸãŒï¼Œãã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒŸã‚¹ã§ãã‚Œãã‚Œã®Hostã«pingã‚’é£›ã°ã—ã¦ã‚‚ãƒ‘ã‚±ãƒƒãƒˆãƒ­ã‚¹ã‚’èµ·ã“ã—ã¦ã—ã¾ã†ï¼

ãã‚Œãã‚Œã®Hostã«pingã‚’é£›ã°ã—ã¦ã‚‚ã€ãƒ‘ã‚±ãƒƒãƒˆãƒ­ã‚¹ã‚’èµ·ã“ã—ã¦ã—ã¾ã†ã€‚
(pingãŒã§ãã‚‹æ™‚ã¨å‡ºæ¥ãªã„ã¨ããŒã‚ã‚‹ã€‚)

## å‰ææ¡ä»¶
- kernelãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã®å¤‰æ›´ã‚’ã—ã¦ã¯ãªã‚‰ãªã„ï¼

## ç†æƒ³ã®çµ‚äº†çŠ¶æ…‹
- ãã‚Œãã‚Œã®Hostã«pingã‚’é£›ã°ã—ã¦ã€ãƒ‘ã‚±ãƒƒãƒˆãƒ­ã‚¹ãŒèµ·ã“ã‚‰ãªã„çŠ¶æ…‹ã«ã™ã‚‹ï¼

## ãã®ä»–ï¼Œå…¬é–‹ã—ã¦ãã‚Œã¦ã„ã‚‹æƒ…å ±

ãƒ¼ãƒ¼èµ·å‹•æ–¹æ³•ãƒ¼ãƒ¼
> cd ~/go/src/github.com/yoneyan/ictsc-ace/cmd/routing
go get .
go build .
sudo ./routing start eth1 eth2 eth3 eth4

ï¼ˆãƒ¡ãƒ¢ï¼šeth1ã¨ã‹ã®éƒ¨åˆ†ã¯æ›¸ãæ›ãˆã¦ã‚ã’ã‚‹å¿…è¦ãŒã‚ã‚‹ï¼‰

[Source Code](https://drive.google.com/file/d/1njTGorOGDsI1yUYpZlMj0bFLBlbukjX4/view?usp=sharing)

----

## æŠ€è¡“èª¿æŸ»

#### èª¿æŸ»æ–¹æ³•
ãƒ­ã‚°ã®ä»•è¾¼ã¿
```go
log.Println("label", "å‡ºåŠ›ã•ã›ãŸã„ã‚‚ã®")
```

#### ã‚³ãƒ¼ãƒ‰ã‚’èª­ã‚“ã§ã¿ã‚‹

- CLIã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½œã‚‹ãŸã‚ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¨ã—ã¦CobraãŒä½¿ã‚ã‚Œã¦ãŸï¼
    - [ã‚ãã‚“ã ](https://github.com/Hunachi/minihuna)
- buildã¨ã‹ã¯ã§ããŸ
    - NICã‚’ç”¨æ„ã—ãŸã‚Šãƒ‘ã‚±ãƒƒãƒˆã‚’é£›ã°ã—åˆã†ã®ãŒç„¡ç†ã ã£ãŸã®ã§ï¼Œå®Ÿéš›ã«å‹•ã‹ã—ã¦ç¢ºèªã¯ã§ããªã‹ã£ãŸï¼
- ã‚³ãƒãƒ³ãƒ‰ã¨ã—ã¦ã‚ã‚‹ã‚‚ã®
    - routor init
    - routor start â†ä»Šå›å©ã„ã¦ã„ã‚‹ã‚³ãƒãƒ³ãƒ‰
    - routor recieve
    - æœªå®Ÿè£…
        - routor init
        - routor store
        - routor router

- ãƒ•ã‚¡ã‚¤ãƒ«åˆ¥ã®å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹å†…å®¹
    - cmd/routing/routing.go
        - ãƒ¡ã‚¤ãƒ³é–¢æ•°ãŒæ›¸ã„ã¦ã‚ã‚‹ã ã‘ï¼
    - pkg/routing/arp/*
        - Macã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å–å¾—ã™ã‚‹ãŸã‚ã®ã‚³ãƒ¼ãƒ‰ï¼ˆarp.goï¼‰ã¨Macã‚¢ãƒ‰ãƒ¬ã‚¹ã®æƒ…å ±ã‚’å…¥ã‚Œã‚‹ãŸã‚ã®æ§‹é€ ä½“ï¼ˆinterface.goï¼‰
    - pkg/routing/cmd/*
        - CLIã®ã‚³ãƒãƒ³ãƒ‰ã®å®Ÿè£…
    - pkg/routing/route/*
        - ä»Šå›ä½¿ã‚ã‚Œã¦ã„ãªã„
    - pkg/routing/router/*
        - ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã®å‡¦ç†ãŒæ›¸ã‹ã‚Œã¦ã„ã‚‹éƒ¨ï¼ˆrouter.goï¼‰ã¨ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°æƒ…å ±ã‚’è©°ã‚ã‚‹ãŸã‚ã®æ§‹é€ ä½“ï¼ˆinterface.goï¼‰
    - pkg/routing/tool/*
        - ä»Šå›ä½¿ã‚ã‚Œã¦ã„ãªã„
    - pkg/routing/interface.go
        - ä»Šå›ä½¿ã‚ã‚Œã¦ã„ãªã„


## è€ƒãˆã‚‰ã‚Œã‚‹æ¤œè¨¼æ‰‹é †

- ã‚³ãƒ¼ãƒ‰ã‚’èª­ã‚€ï¼ˆèª­ã‚“ã ï¼‰
- Logã‚’åŸ‹ã‚è¾¼ã‚€
- ã©ã‚“ãªãƒ‘ã‚±ãƒƒãƒˆãŒè½ã¡ã¦ã‚‹ã‹ã¿ã‚‹

## åŸå› ã®å€™è£œ

- ã‚³ãƒ¼ãƒ‰ã‚’èª­ã‚“ã æ„Ÿæƒ³
    - Ipv6ã«å¯¾å¿œã—ã¦ãªã„ã‹ã‚‰ï¼Ÿ
        - ã“ã‚Œã ã£ãŸã‚‰ãƒˆãƒ©ã‚³ãƒ³ã˜ã‚ƒãªã„ï¼
    - Macã‚¢ãƒ‰ãƒ¬ã‚¹ã¨IPã‚¢ãƒ‰ãƒ¬ã‚¹ã®çµ„ã¿ãŒå¤‰ã‚ã£ãŸã¨ãã«å¯¾å¿œã§ããªã„ã‹ã‚‰ï¼Ÿ

---- 

## è§£èª¬

### åŸå› 

> åŸå› ã¯Golangã«ã¦ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã®å®Ÿè£…ã«å•é¡ŒãŒã‚ã‚‹ã“ã¨ãŒåŸå› ã§ã™ã€‚
Golangã«ã¦ã€Channelã‚’ä½¿ã£ãŸå‡¦ç†ã«ãƒŸã‚¹ãŒç”Ÿã˜ã¦ãŠã‚Šã€é©åˆ‡ãªNICã«ãƒ‘ã‚±ãƒƒãƒˆã‚’é€ã‚Šå‡ºã›ã¦ã„ãªã„ãŸã‚èµ·ãã¦ã„ã‚‹å•é¡Œã§ã™ã€‚

> HostA => HostDå®›ã«Pingã‚’é£›ã°ã—ãŸå ´åˆã§ã‚‚ã€Channelã®å®Ÿè£…ãƒŸã‚¹ã«ã‚ˆã‚ŠHostA,B,C,Dã®ã©ã‚Œã‹ã«ãƒ‘ã‚±ãƒƒãƒˆè»¢é€ã—ã¦ã—ã¾ã†ã¨ã„ã†ãƒã‚°ã«ã‚ˆã£ã¦å¼•ãèµ·ã“ã•ã‚Œã‚‹å•é¡Œã§ã™ã€‚

### è§£æ±ºæ–¹æ³•

```go
pkg/routing/router/router.go
 
 
 func routerReceive(device string) error {
                                if err != nil {
                                        log.Println(err)
                                }
+                       } else {
+                               packets <- msg
                        }
                }
        }()

```


### è§£èª¬ã«å¯¾ã™ã‚‹ãƒ¡ãƒ¢

`router.go`å†…ã®ï¼Œ
```go
msg := <-packets
			if msg.Interface == mac.String() {
				err := handle.WritePacketData(msg.Packets)
				if err != nil {
					log.Println(err)
				}
			}
```
ã®éƒ¨åˆ†ã§ï¼Œã‚ã‚‹ã‚¹ãƒ¬ãƒƒãƒ‰ï¼ˆgoroutineï¼‰ãŒæŒ‡å®šã—ãŸãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ‡ãƒã‚¤ã‚¹(NIC)ã§é€ä¿¡ã—ãªã„ãƒ‘ã‚±ãƒƒãƒˆã‚’å—ã‘å–ã£ãŸå ´åˆã«ãƒ‘ã‚±ãƒƒãƒˆã‚’ç ´æ£„ã—ã¦ã—ã¾ã£ã¦ã„ã‚‹ã“ã¨ãŒåŸå› ï¼
æœ¬å½“ã¯ï¼Œè‡ªåˆ†ãŒé€ä¿¡ã™ã‚‹ãƒ‘ã‚±ãƒƒãƒˆã˜ã‚ƒãªã‹ã£ãŸã‚‰ä»–ã®NICã‚’æŒ‡å®šã—ãŸã‚¹ãƒ¬ãƒƒãƒ‰ï¼ˆgoroutineï¼‰ã«æ¸¡ã—ã¦ã‚ã’ãªã„ã¨ã„ã‘ãªã„ï¼
ã¨è¨€ã†ã“ã¨ã«æ°—ãŒä»˜ã‘ãªãã¦ï¾‹ï¾Ÿï½´ï¾ğŸ¥º

## æ¡ç‚¹åŸºæº–

ãƒ‘ã‚±ãƒƒãƒˆãƒ­ã‚¹ã‚’ã›ãšã«pingãŒé£›ã¶ã“ã¨(100%)